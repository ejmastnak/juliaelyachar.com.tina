---
import client from "@tina/__generated__/client";
import BaseLayout from "@/layouts/BaseLayout.astro";
import Home from "@tina/pages/Home/Index.tsx";
import { optimizeTinaImages } from '@/lib/optimizeTinaImages';

const content = await client.queries.myHomePage({ relativePath: "index.json" });
const eventsResponse = await client.queries.eventConnection();
const publications = await client.queries.myPublication({ relativePath: "index.json" });

const events = eventsResponse.data.eventConnection.edges.map((edge) => edge.node);

const head = content.data.homePage.head;

await optimizeTinaImages(content, [
  {
    srcPath: ['data', 'homePage', 'heroImg'],
    altPath: ['data', 'homePage', 'heroImgAlt'],
    width: 700,
  },
  {
    srcPath: ['data', 'homePage', 'bookImg'],
    altPath: ['data', 'homePage', 'bookImgAlt'],
    width: 800,
  },
]);

// Optimize the images in displayed publications
const publicationImagesToOptimize = publications.data.publication.publications.reduce((acc, publication, idx) => {
  if (publication.featured) {
    acc.push({
      srcPath: ['data', 'publication', 'publications', `${idx}`, 'img'],
      altPath: ['data', 'publication', 'publications', `${idx}`, 'imgAlt'],
      width: 512,
      idx: idx,
    });
  }
  return acc;
}, []);
await optimizeTinaImages(publications, publicationImagesToOptimize);

---

<BaseLayout head={head}>
  <Home {...content} events={events} publicationsData={publications.data} client:tina />
</BaseLayout>
