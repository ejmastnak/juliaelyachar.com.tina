---
import client from "@tina/__generated__/client";
import BaseLayout from "@/layouts/BaseLayout.astro";
import Index from "@tina/pages/Index/Index.tsx";
import { optimizeTinaImages } from '@/lib/optimizeTinaImages';

const content = await client.queries.myHomePage({ relativePath: "index.json" });
const eventsResponse = await client.queries.eventConnection();
const publicationsResponse = await client.queries.publicationConnection({
  filter: { featured: { eq: true } },
});

const events = eventsResponse.data.eventConnection.edges.map((edge) => edge.node);
const publications = publicationsResponse.data.publicationConnection.edges.map((edge) => edge.node);

const head = content.data.homePage.head;

await optimizeTinaImages(content, [
  {
    srcPath: ['data', 'homePage', 'heroImg'],
    altPath: ['data', 'homePage', 'heroImgAlt'],
    width: 700,
  },
  {
    srcPath: ['data', 'homePage', 'bookImg'],
    altPath: ['data', 'homePage', 'bookImgAlt'],
    width: 800,
  },
]);

// Optimize the images in displayed publications
const publicationImagesToOptimize = publications.map((publication, idx) => {
  return {
    srcPath: [`${idx}`, 'img'],
    altPath: [`${idx}`, 'imgAlt'],
    width: 512,
    idx: idx,
  }
});
await optimizeTinaImages(publications, publicationImagesToOptimize);

---

<BaseLayout head={head}>
  <Index {...content} events={events} publications={publications} client:tina />
</BaseLayout>
